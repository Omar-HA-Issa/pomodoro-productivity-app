trigger:
  - main

pool:
  name: Default

workspace:
  clean: all

variables:
  backend_dir: 'backend'

steps:
  - script: |
      cd $(backend_dir)
      npm ci
    displayName: "Install backend dependencies"

  # Delete any existing database file to avoid corruption
  - script: |
      cd $(backend_dir)
      del pomodoro.db 2>nul || echo "No database to delete"
    displayName: "Clean database file"
    continueOnError: true

  - script: |
      cd $(backend_dir)
      npm test
    displayName: "Run Jest tests with coverage"

  - script: |
      cd $(backend_dir)
      npm run build
    displayName: "Build backend application"