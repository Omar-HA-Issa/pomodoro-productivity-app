trigger:
  branches:
    include:
      - main

variables:
  # Backend
  backend_dir: 'backend'
  backend_imageRepository: 'pomodoroapp'

  # Frontend
  frontend_dir: 'frontend'
  frontend_imageRepository: 'pomodoroapp-frontend'

  # Shared
  containerRegistry: 'pomodoroapp.azurecr.io'
  dockerRegistryServiceConnection: 'pomodoroapp-acr-connection'
  tag: '$(Build.BuildId)'

stages:
  - stage: CI
    displayName: "Build & Test backend and frontend"
    jobs:
      - job: Backend_CI
        displayName: "Backend - tests with coverage"
        pool:
          name: Default
        workspace:
          clean: all
        steps:
          - script: |
              cd $(backend_dir)
              npm ci
            displayName: "Install backend dependencies"

          - script: |
              cd $(backend_dir)
              npm test
            displayName: "Run backend Jest tests with coverage"

          - script: |
              cd $(backend_dir)
              npm run build
            displayName: "Build backend application"

      - job: Frontend_CI
        displayName: "Frontend - build only"
        pool:
          name: Default
        workspace:
          clean: all
        steps:
          - script: |
              cd $(frontend_dir)
              npm ci
            displayName: "Install frontend dependencies"

          - script: |
              cd $(frontend_dir)
              npm run build
            displayName: "Build frontend application"

  - stage: Build_And_Push_Image
    displayName: "Build & push Docker images to ACR"
    dependsOn: CI
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: Docker_Build_Push
        displayName: "Docker build & push backend + frontend"
        pool:
          name: Default
        steps:
          - task: Docker@2
            displayName: "Build and push BACKEND image to ACR"
            inputs:
              command: "buildAndPush"
              containerRegistry: "$(dockerRegistryServiceConnection)"
              repository: "$(backend_imageRepository)"
              dockerfile: "backend/Dockerfile"
              buildContext: "$(Build.SourcesDirectory)/backend"
              tags: |
                $(tag)

          - task: Docker@2
            displayName: "Build and push FRONTEND image to ACR"
            inputs:
              command: "buildAndPush"
              containerRegistry: "$(dockerRegistryServiceConnection)"
              repository: "$(frontend_imageRepository)"
              dockerfile: "frontend/Dockerfile"
              buildContext: "$(Build.SourcesDirectory)/frontend"
              tags: |
                $(tag)

  - stage: Deploy
    displayName: "Deploy backend & frontend to Azure Web Apps (Containers)"
    dependsOn: Build_And_Push_Image
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployWebApps
        displayName: "Update Web App containers"
        pool:
          name: Default
        steps:
          - powershell: |
              $ErrorActionPreference = "Stop"

              $azPath = "C:\Program Files (x86)\Microsoft SDKs\Azure\CLI2\wbin\az.cmd"
              Write-Host "Using Azure CLI at: $azPath"
              & "$azPath" --version

              Write-Host "Setting BACKEND container image on Web App..."
              & "$azPath" webapp config container set `
                --name pomodoroapp `
                --resource-group BCSAI2025-DEVOPS-STUDENTS-A `
                --docker-custom-image-name $(containerRegistry)/$(backend_imageRepository):$(tag) `
                --docker-registry-server-url https://$(containerRegistry) `
                --docker-registry-server-user $env:ACR_USERNAME `
                --docker-registry-server-password $env:ACR_PASSWORD

              Write-Host "Setting FRONTEND container image on Web App..."
              & "$azPath" webapp config container set `
                --name pomodoroapp-frontend `
                --resource-group BCSAI2025-DEVOPS-STUDENTS-A `
                --docker-custom-image-name $(containerRegistry)/$(frontend_imageRepository):$(tag) `
                --docker-registry-server-url https://$(containerRegistry) `
                --docker-registry-server-user $env:ACR_USERNAME `
                --docker-registry-server-password $env:ACR_PASSWORD

              Write-Host "Restarting BACKEND Web App..."
              & "$azPath" webapp restart `
                --name pomodoroapp `
                --resource-group BCSAI2025-DEVOPS-STUDENTS-A

              Write-Host "Restarting FRONTEND Web App..."
              & "$azPath" webapp restart `
                --name pomodoroapp-frontend `
                --resource-group BCSAI2025-DEVOPS-STUDENTS-A
            displayName: "Update backend & frontend Web App containers"
            env:
              ACR_USERNAME: $(ACR_USERNAME)
              ACR_PASSWORD: $(ACR_PASSWORD)
