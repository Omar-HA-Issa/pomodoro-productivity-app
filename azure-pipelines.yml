trigger:
  branches:
    include:
      - main


variables:
  backend_dir: 'backend'
  imageRepository: 'pomodoroapp'
  containerRegistry: 'pomodoroapp.azurecr.io'
  dockerRegistryServiceConnection: 'pomodoroapp-acr-connection'
  tag: '$(Build.BuildId)'

stages:

  - stage: CI
    displayName: "Build & Test backend"
    jobs:
      - job: Backend_CI
        displayName: "Run backend tests with coverage"
        pool:
          name: Default

        workspace:
          clean: all

        steps:
          - script: |
              cd $(backend_dir)
              npm ci
            displayName: "Install backend dependencies"

          - script: |
              cd $(backend_dir)
              npm test
            displayName: "Run Jest tests with coverage"

          - script: |
              cd $(backend_dir)
              npm run build
            displayName: "Build backend application"

  - stage: Build_And_Push_Image
    displayName: "Build & push Docker image to ACR"
    dependsOn: CI
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

    jobs:
      - job: Docker_Build_Push
        displayName: "Docker build & push"
        pool:
          name: Default

        steps:
          - task: Docker@2
            displayName: "Build and push image to ACR"
            inputs:
              command: "buildAndPush"
              containerRegistry: "$(dockerRegistryServiceConnection)"
              repository: "$(imageRepository)"
              dockerfile: "backend/Dockerfile"
              buildContext: "$(Build.SourcesDirectory)/backend"
              tags: |
                $(tag)

  - stage: Deploy
    displayName: "Deploy to Azure Web App (Container)"
    dependsOn: Build_And_Push_Image
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

    jobs:
      - job: DeployWebApp
        displayName: "Deploy container to Web App"
        pool:
          name: Default

        steps:
          - powershell: |
              Write-Host "Setting container image on Web App..."
              az webapp config container set `
                --name pomodoroapp `
                --resource-group BCSAI2025-DEVOPS-STUDENTS-A `
                --docker-custom-image-name $(containerRegistry)/$(imageRepository):$(tag) `
                --docker-registry-server-url https://$(containerRegistry) `
                --docker-registry-server-user $env:ACR_USERNAME `
                --docker-registry-server-password $env:ACR_PASSWORD

              Write-Host "Restarting Web App..."
              az webapp restart `
                --name pomodoroapp `
                --resource-group BCSAI2025-DEVOPS-STUDENTS-A
            displayName: "Update Web App container image"
            env:
              ACR_USERNAME: $(ACR_USERNAME)
              ACR_PASSWORD: $(ACR_PASSWORD)
